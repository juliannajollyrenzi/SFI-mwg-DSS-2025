---
title: "Analysis: using comstab with MCR fish data"
author: "Julianna Renzi"
date: "2025-07-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
# Clear environment for maximum reproducibility
rm(list=ls())

# load librarian (package for installing/loading packages)
if (!require("librarian")) install.packages("librarian")

# Load other necessary libraries
librarian::shelf(here, # relative file paths
                 tidyverse # data wrangling
)
```

# Bring in data

```{r}
mcr_fish <- read_csv(here("CSVs", "data_cleaned", "mcr_fish_biomass_5x50m2.csv"))
```

# Source Reilly's functions

```{r}
source(here("R", "functions", "00_Functions.R"))
```

Geometric mean function

```{r}
CalcZeroInfGeomDens = function(x){
  prob_obs = sum(x > 0)/length(x)
  geom_mean_dens = ifelse(prob_obs > 0, exp(mean(log(x[x > 0]))), 0)
  return(geom_mean_dens * prob_obs)
}
```

# Set graphing theme

```{r set graphing theme}
# ggplot theme
theme_set(
  theme_bw(base_size = 20) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    theme(plot.title = element_text(vjust = -6))
) 
```

# Get data into year-species matrix

```{r}
mcr_fish %>% 
  group_by(dataset, site, habitat, year, plot, taxon_name) %>% 
  summarize(mean_biomass_g_per_5x50m2 = mean(biomass_g_per_5x50_m2)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = taxon_name, values_from = mean_biomass_g_per_5x50m2,
              values_fill = 0) -> mcr_wide
```

# All time MCR stats

## Make functions to get all time stats for MCR sites

```{r}
partition_mcr <- function(df, condition) {
  # 'condition' should be an expression to filter for that can be evaluated in the context of df
  
  # filter df for the site/community we are interested in
  df %>% 
    filter(plot == condition) %>%
    select(-dataset, -site, -habitat, -plot) %>% 
    rename(Year = year) -> df_2
  
  # get partitionR results
  part <- partitionR(as.matrix(df_2)) 
  # get warnings to store
  captured <- capture_warnings(partitionR(as.matrix(df_2)))
  
  cbind("Community" = as.character(condition), t(part$CVs), t(as.data.frame(part$Stabilization)),
        t(part$Relative), t(part$TPLs), "Warnings" = captured$warnings) -> df_3
  
  rownames(df_3) <- NULL
  df_3
}
```

Iterate over a list of MCR sites

```{r}
partition_many_mcr <- function(df, conditions) {
  # initialize the dataframe
  megadf <- partition_mcr(df, conditions[1])
  
  # iterate over each site
 for(i in 2:length(conditions)) {
   megadf <- rbind(megadf, partition_mcr(mcr_wide, conditions[i]))
 }
  
  # add metadata
  megadf %>% 
    as.data.frame() %>% 
    rowwise() %>% 
    mutate(Site = paste0("LTER_", str_split(Community, "_")[[1]][2])) %>% 
    mutate(Habitat = str_split(Community, "_")[[1]][3])
}

```

Do it for all of the sites

```{r}
mcr_alltime <- partition_many_mcr(df = mcr_wide, conditions = unique(mcr_wide$plot))
```

## Plot

```{r}
mcr_alltime %>% 
  select(Community, Site, Habitat, CVe, CVtilde, CVa, CVc) %>% 
  pivot_longer(cols = c("CVe", "CVtilde", "CVa", "CVc"), names_to = "Component", values_to = "CV") %>% 
  mutate(CV = as.numeric(CV)) %>% 
  group_by(Habitat, Component) %>% 
  summarize(mean_CV = mean(CV),
            se = sd(CV)/sqrt(n())) %>% 
  # re-level so they match
  mutate(Component = factor(Component, levels = c("CVe", "CVtilde", "CVa", "CVc"))) %>% 
  ggplot(aes(x = Component, y = (mean_CV), group = Habitat, color = Habitat)) +
  geom_point(size = 3) +
  scale_x_discrete(labels = c("CVa" = expression("CV"[a]), 
                                                 "CVc" = expression("CV"[c]), 
                                                 "CVe" = expression("CV"[e]), 
                                                 "CVtilde" = expression(tilde("CV")))) +
  geom_errorbar(aes(ymin = (mean_CV - se), ymax = (mean_CV + se)), width = 0.2) +
  geom_line()
```








# Rolling window: Backreef LTER 1

```{r}
mcr_wide %>% 
  filter(plot == "lter_1_backreef") %>%
  select(-dataset, -site, -habitat, -plot) %>% 
  rename(Year = year) -> backreef_1
```

## Apply Partitions

```{r}
part_zhao_back1 <- zhao_decomp_w(backreef_1)
```

```{r}
part_back1 <- rollapply(data = backreef_1, width = 10, by = 1, FUN = partitionR_window, by.column = FALSE, align = "left") %>% 
  as.data.frame() %>% 
  mutate(across(-warnings, as.numeric))
```

## Plot CV through time

```{r}
part_back1 %>% 
  select(start_year, CVe, CVtilde, CVa, CVc) %>% 
  pivot_longer(cols = c(CVe, CVtilde, CVa, CVc), names_to = "CV_type", values_to = "CV") %>% 
  ggplot(aes(x = start_year, y = CV)) +
  geom_line(aes(x = start_year, y = CV, group = CV_type, color = CV_type)) +
  ylab("CV") +
  xlab("First year of window") +
  scale_colour_viridis_d(name = "CV", labels = c("CVa" = expression("CV"[a]), 
                                                 "CVc" = expression("CV"[c]), 
                                                 "CVe" = expression("CV"[e]), 
                                                 "CVtilde" = expression(tilde("CV")))) 
```


Recall:
- CVa = CVcom with asynchrony only
- CVe = CV of an average species
- CVtilde = expected CVcom under assumption of perfect synchrony but realized dominance structure
- IS CVc the expected community CV?

## Look at all of the power law relationships for any window size

```{r}
plot_TPL(backreef_1, window_size = 15, ny = 1, form = "vari")
```






